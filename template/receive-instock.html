<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>贴签入库</title>
  <link rel="shortcut icon" href="static/favicons.png"/>
  <style type="text/css">
  /*@charset "UTF-8";[ng:cloak],[ng-cloak],[data-ng-cloak],[x-ng-cloak],.ng-cloak,.x-ng-cloak,.ng-hide:not(.ng-hide-animate){display:none !important;}ng:form{display:block;}*/
  .tip-div{
    text-align: center;
    /*border: 1px solid red;*/
    /*margin:auto;*/
  }
  #tx{
    text-indent: 12px;
    width: 200px;
    /*position: absolute;
    left: 50%;
    transform: translateX(-50%);
    top: 200px;*/
  }
  .rk-wrap{
    position: fixed;
    top: 0;
    left: 0;
    background-color: rgba(0,0,0,0.3);
    width: 100%;
    height: 100%;
    /*display: none;*/
    z-index: 99;
  }
  .changebz-wrap,.chage-wrap{
    position: fixed;
    top: 0;
    left: 0;
    background-color: rgba(0,0,0,0.3);
    width: 100%;
    height: 100%;
    z-index: 99;
  }
  .index-wrap{
    z-index: 999;
  }
  .ydh-rk-wrap{
    position: fixed;
    top: 0;
    left: 0;
    background-color: rgba(0,0,0,0.3);
    width: 100%;
    height: 100%;
    z-index: 99;
  }
  .changWeight-con{
    width: 1000px;
    height: 520px;
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    border-radius: 4px;
    border: 1px solid #ececec;
    background-color: #fff;
    padding: 20px 10px;
    text-align: center;
  }
  .rk-con {
    width: 1000px;
    height: 520px;
    margin: 20px auto;
    border-radius: 4px;
    border: 1px solid #ececec;
    background-color: #f8f8f8;
    padding: 20px 10px;
    text-align: center;
    box-shadow: 0 0 10px #eee;
  }
  .changWeight-con{
    width: 450px;
    height: 190px;
  }
  .qs-con{
    width: 450px;
    height: 190px;
  }
  .changWeight-con p{
    font-size: 18px;
  }
  .next-change{
    height: 120px;
  }
  .next-change p{
    font-size: 14px;
  }
  .next-change .btn-primary{
    margin-left: 50px;
  }
  .changWeight-con .cwtip-p{
    font-size: 12px;
  }
  .changWeight-con label{
    font-size: 12px;
    font-weight: normal;
  }
  .rk-main {
    /*overflow: hidden;*/
  }
  .rk-main .rk-left {
    float: left;
    width: 50%;
    height: 420px;
    /*overflow-y: auto;*/
  }
  .ydh-rk-left{
    padding-right: 20px;
  }
  .rk-main .rk-right {
    float: left;
    width: 50%;
    height: 420px;
    overflow-y: auto;
  }
  .rk-sp-img{
    max-width: 260px;
    max-height: 300px;
  }
  .rksp-detailcon ul{
    list-style: none;
    padding:0;
  }
  .rksp-detailcon li{
    padding: 10px 0;
    height: 40px;
    /*border: 1px solid blue;*/
  }
  .rk-num{
    text-indent: 12px;
  }
  .rksp-detailcon select{
    width: 60%;
    height: 30px;
    border-radius: 4px;
  }
  .rkspdetail-left{
    /*border:1px solid red;*/
    width: 28%;
    display: inline-block;
    vertical-align: top;
    text-align: right;
  }
  .rkspdetail-right{
    /*border:1px solid red;*/
    width: 70%;
    display: inline-block;
    vertical-align: top;
    text-align: left;
  }
  .selck-div{
    margin-top: 20px;
  }
  .rk-btns{
    margin-top: 20px;
    text-align: center;
  }
  .rk-btns .qs-btn{
    margin-left: 50px;
  }
  #sure-rktk{
    margin-left: 20px;
  }
  /*树样式*/
  ul.domtree,ul.domtree ul {
      margin: 0;
      /*padding: 0 0 0 2em;*/
      padding: 0 0 0 2.5em;
  }

  ul.domtree li {
      list-style: none;
      position: relative;
      color: #B05609;
      line-height: 2em;
      font-size: 16px;
  }

  ul.domtree>li:first-child:before {
      border-style: none none solid none;
  }

  ul.domtree li:before {
      position: absolute;
      content: '';
      top: -0.01em;
      left: -0.7em;
      width: 0.5em;
      height: 1em;
      /* height: 0.615em; */
      border-style: none none solid solid;
      /* border-width: 1px; */
      border-width: 0.05em;
      border-color: #FFB85F;
  }

  ul.domtree li:not(:last-child):after {
      position: absolute;
      content: '';
      top: -0.1em;
      /* top: 0.7em; */
      left: -0.7em;
      bottom: 0;
      border-style: none none none solid;
      /* border-width: 1px; */
      border-width: 0.05em;
      border-color: #FFB85F;
  }
  .openup-icon, .packup-icon {
    display: inline-block;
    width: 16px;
    height: 16px;
    line-height: 16px;
    text-align: center;
    background: #FCF4D9;
    color: #FFB85F;
  }
  .name-span {
    cursor: pointer;
    display: inline-block;
    padding: 0 5px;
    font-size: 14px;
    height: 24px;
    line-height: 24px;
  }
  .name-span.active {
    background: #f7debd;
  }
  p.top-info {
    text-align: left;
    margin: 0;
  }
  .rk-wight{
    vertical-align: top;
  }
  .inp-erractive{
    border: 1px solid red;
    color: red;
  }
  .inp-sucactive{
    border: 1px solid green;
    color: green;
  }
  .selck-div .radio-inp{
    margin-right: 20px;
  }
  .ydh-img-box {
    position: relative;
    display: block;
    width: 60px;
    height: 60px;
    margin: 0 auto;
  }
  .ydh-img{
    max-height: 60px;
    max-width: 60px;
  }
  .ydh-img-box .ydh-big-img {
    position: absolute;
    left: 60px;
    top: 0;
    display: none;
    z-index: 9;
  }
  .ydh-img-box:hover .ydh-big-img {
    display: block;
  }
  .ydh-tit{
    font-size: 18px;
    font-weight: 500;
  }
  .bulk-ydhrk{
    float: right;
    margin-right: 50px;
  }
  .ydh-rktit{
    font-size: 18px;
    font-weight: 500;
  }
  .ydhrk-detailcon{
    /*height: 425px;
    overflow-y: auto;*/
  }
  /*运单号入库重量的输入框*/
  .ydh-table th{
    text-align: center;
  }
  .ydh-table td{
    text-align: center;
  }
  .ydh-weightInp{
    width: 80px;
  }
  .qs-res-con textarea{
    resize: none;
    width: 100%;
    height: 100px;
    border-radius: 4px;
  }
</style>
</head>
<script type="text/javascript" src="static/js/public/jquery-3.0.0.min.js"></script>
<script type="text/javascript" src="static/angular-1.5.8/angular.min.js"></script>
<link rel="stylesheet" type="text/css" href="static/bootstrap-3.3.7-dist/css/bootstrap.min.css">
<script type="text/javascript" src="static/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
<body ng-app="barcodeApp" ng-controller="barcodeAppCtrl">
      <!-- <div class="bg-wrap"></div> -->
      <div class="tip-div">
        <p>
          <font size='10' color="lightseagreen">贴签入库</font>
        </p>
        <input id="tx" type="text" placeholder="请扫描条形码" />
      </div>
      <div class="rk-con">
                <!-- <p class="ydh-rktit">运单号入库</p> -->
                <div class="rk-main">
                  <div class="rksp-detailcon ydhrk-detailcon">
                      <table class="table table-bordered ydh-table" ng-show="condition === 'oldVersion'">
                          <thead>
                            <tr>
                              <th>图片</th>
                              <th>SKU</th>
                              <!-- <th>日期</th> -->
                              <th>总数量</th>
                              <th>商品重量</th>
                              <th>操作</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr ng-repeat="item in ydhList">
                              <td>
                                <a href="{{'manage.html#/merchandise/show-detail/' + item.productId + '/0/3/0'}}" target="_blank" class="ydh-img-box">
                                  <img class="ydh-img" ng-src="{{item.img}}">
                                  <img class="ydh-big-img" ng-src="{{item.img}}">
                                </a>
                              </td>
                              <td>{{item.sku}}</td>
                              <!-- <td>{{bulkRkTime}}</td> -->
                              <td>{{item.count}}</td>
                              <td>
                                 <!-- ng-class="{{item.isChangeWeight=='0'?'inp-erractive':'inp-sucactive'}}" -->
                                <input class="ydh-weightInp" ng-class="{'inp-erractive':item.isChangeWeight!='1','inp-sucactive':item.isChangeWeight=='1'}" type="number" ng-blur="isValidWFun(item,$index,$event)" ng-focus="isVaildFocus()" value="{{item.oldWeight}}"></input>
                                <!-- <button class="btn btn-primary" ng-show="weightShow" ng-click="setWeight()">重新获取重量</button> -->
                              </td>
                              <td>
                                <button class="btn btn-primary" ng-click="yiChangFun(item)">异常</button>
                              </td>
                            </tr>
                          </tbody>
                      </table>
                      <table class="table table-bordered ydh-table" ng-show="condition === 'latestVersion'">
                        <thead>
                          <tr>
                            <th>图片</th>
                            <th>SKU</th>
                            <th>入驻供应商名称</th>
                            <th>总数量</th>
                            <th>商品重量</th>
                            <th>操作</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr ng-repeat="item in list">
                            <td>
                              <a href="javascript:;" target="_blank" class="ydh-img-box" ng-show="item.imageUrl">
                                <img class="ydh-img" ng-src="{{item.imageUrl}}">
                                <img class="ydh-big-img" ng-src="{{item.imageUrl}}">
                              </a>
                            </td>
                            <td>{{item.sku}}</td>
                            <td>{{item.companyName}}</td>
                            <td>{{item.productNum}}</td>
                            <td>
                               <!-- ng-class="{{item.isChangeWeight=='0'?'inp-erractive':'inp-sucactive'}}" -->
                              <input class="ydh-weightInp" ng-class="{'inp-erractive':item.isChangeWeight!='1','inp-sucactive':item.isChangeWeight=='1'}" type="number" ng-blur="checkWeight(item,$index,$event)" value="{{item.grams}}"></input>
                              <!-- <button class="btn btn-primary" ng-show="weightShow" ng-click="setWeight()">重新获取重量</button> -->
                            </td>
                            <td>
                              <button class="btn btn-primary" ng-click="showErrBox(item)">异常</button>
                            </td>
                          </tr>
                        </tbody>
                    </table>
                  </div>
                </div>
                <div class="rk-btns">
                  <!-- <button type="button" class="btn btn-default" ng-click="ydhCloseRk()">关闭</button> -->
                  <!-- <button style="float: right; margin-right: 50px;" type="button" class="btn btn-primary" ng-click="ydhRkSureFun()">批量入库</button> -->
                </div>
              </div>
      <!-- <div class="modal fade" id="exampleModal"  role="dialog" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span id="sp" aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">sku详情</h4>
              </div>
            <div class="modal-body">
              <form>
                <div class="row">
      		        <div class="col-xs-6 col-md-3">
      		          <a href="#" class="thumbnail">
      		            <img src="#" id="vimg"/>
      		          </a>
      		        </div>
                  <button type="button" ng-click="rkBtnFun($event)" id="rk-btn" class="btn btn-primary">入库</button>
      		      </div>
                <div class="form-group">
                  <label for="recipient-name" class="control-label">sku :</label>
                  <input type="text" id="vsku" readonly="readonly" class="form-control" id="recipient-name">
                </div>
                <div class="form-group">
                  <label for="recipient-name" class="control-label">日期 :</label>
                  <input type="text" id="vdt" readonly="readonly" class="form-control" id="recipient-name">
                </div>
                <div class="form-group">
                  <label for="recipient-name" class="control-label">总数量 :</label>
                  <input type="text" id="vco" readonly="readonly" class="form-control" id="recipient-name">
                </div>
                <div class="form-group">
                  <label for="recipient-name" class="control-label">单品直发数量 :</label>
                  <input type="text" id="vcone" readonly="readonly" class="form-control" id="recipient-name">
                </div>
                <div class="form-group">
                  <label for="recipient-name" class="control-label">多品入库数量 :</label>
                  <input type="text" id="vcmore" readonly="readonly" class="form-control" id="recipient-name">
                </div>
              </form>
            </div>
          </div>
        </div>
      </div> -->
      <!-- 运单号入库的弹框 -->
      <!-- <div class="modal fade" id="YdhModal"  role="dialog" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span id="sp" aria-hidden="true">&times;</span></button>
                <span class="ydh-tit">sku详情</span>
                
                <button type="button" ng-click="ydhRkFun()" class="btn btn-primary bulk-ydhrk">批量入库</button>
                <button type="button" class="btn btn-primary bulk-ydhrk" ng-click="ydhRkQsFun()">签收</button>
                <button type="button" class="btn btn-primary bulk-ydhrk" ng-click="bulkPrintOFun()">批量打印条形码</button>
              </div>
            <div class="modal-body">
              <table class="table table-bordered ydh-table">
                  <thead>
                    <tr>
                      <th>图片</th>
                      <th>SKU</th>
                      <th>总数量</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr ng-repeat="item in ydhList">
                      <td>
                        <img class="ydh-img" ng-src="{{item.img}}">
                      </td>
                      <td>
                        <p>{{item.sku}}</p>
                        <p>{{item.shortSku}}</p>
                      </td>
                      <td>{{item.count}}</td>
                    </tr>
                  </tbody>
              </table>  
            </div>
          </div>
        </div>
      </div> -->

    <!-- sku/条形码入库弹框 -->
    <div class="rk-wrap ng-hide" ng-show="skuorTxmFlag">
      <div class="rk-con">
        <div class="rk-main">

          <div class="rk-left">

            <div class="rksp-imgcon">
              <img class="rk-sp-img" src="">
            </div>
            <div class="rksp-detailcon">
              <div class="rkspdetail-left">
                <ul>
                  <li><span>sku:</span></li>
                  <li><span>入库数量:</span></li>
                  <li><span>商品重量:</span></li>
                </ul>
              </div>
              <div class="rkspdetail-right">
                <ul>
                  <li>
                    <span class="sku-text"></span>
                  </li>
                  <li>
                    <input type="number" class="rk-num"></input>
                  </li>
                  <li>
                    <input type="number" class="rk-weight"></input>
                    <button class="btn btn-primary" ng-click="editWeiFun()">提交</button>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="rk-right">
            <div class="selck-div">
              请选择仓库:
              <p ng-show="moreFlag">
                <label>义乌仓:</label>
                <input class="radio-inp" ng-click="selCkFun($event)" type="radio" name="ckradio" value="1" checked></input>
                <label>深圳仓:</label>
                <input class="radio-inp" ng-click="selCkFun($event)" type="radio" name="ckradio" value="2"></input>
                <label>美国仓:</label>
                <input class="radio-inp" ng-click="selCkFun($event)" type="radio" name="ckradio" value="3"></input>
              </p>
            </div>
            <div class="asj-tree-box">
              <folder-tree current-folder="folder" my-index="index1" point-one="pointOne(item,event,posi)" switch-list="switchList(posi,event,flag)"></folder-tree>
            </div>
          </div>
        </div>
        <!-- <p class="bt-idtext"></p>
        <p class="sp-idtext"></p>
        <p class="yd-idtext"></p> -->
        <div class="rk-btns">
          <button type="button" class="btn btn-default" ng-click="skuOrTxmCloseFun()" id="close-rktk">关闭</button>
          <button type="button" ng-click="sureRkFun()" class="btn btn-primary" id="sure-rktk">确定</button>
        </div>
      </div>
    </div>
    <!-- 运单号入库弹框 -->
    <div class="ydh-rk-wrap ng-hide stop-pro" ng-show="ydhrkFlag">
      <div class="rk-con">
        <p class="ydh-rktit">运单号入库</p>
        <div class="rk-main">
          <div class="rksp-detailcon ydhrk-detailcon">
              <table class="table table-bordered ydh-table">
                  <thead>
                    <tr>
                      <th>图片</th>
                      <th>SKU</th>
                      <!-- <th>日期</th> -->
                      <th>总数量</th>
                      <th>商品重量</th>
                      <!-- <th>仓库</th> -->
                    </tr>
                  </thead>
                  <tbody>
                    <tr ng-repeat="item in ydhList">
                      <td>
                        <a href="{{'manage.html#/merchandise/show-detail/' + item.productId + '/0/3/0'}}" target="_blank" class="ydh-img-box">
                          <img class="ydh-img" ng-src="{{item.img}}">
                          <img class="ydh-big-img" ng-src="{{item.img}}">
                        </a>
                      </td>
                      <td>{{item.sku}}</td>
                      <!-- <td>{{bulkRkTime}}</td> -->
                      <td>{{item.count}}</td>
                      <td>
                         <!-- ng-class="{{item.isChangeWeight=='0'?'inp-erractive':'inp-sucactive'}}" -->
                        <input class="ydh-weightInp" ng-class="{'inp-erractive':item.isChangeWeight!='1','inp-sucactive':item.isChangeWeight=='1'}" type="number" ng-blur="isValidWFun(item,$index,$event)" value="{{item.oldWeight}}"></input>
                      </td>
                      <!-- <td>{{item.storageName}}</td> -->
                    </tr>
                  </tbody>
              </table>
          </div>
        </div>
        <div class="rk-btns">
          <button type="button" class="btn btn-default" ng-click="ydhCloseRk()">关闭</button>
          <button type="button" class="btn btn-primary" ng-click="ydhRkSureFun()">确定</button>
        </div>
      </div>
    </div>
    <!-- 修改包装重量 -->
    <div class="changebz-wrap index-wrap ng-hide stop-pro" ng-show="changeWFlag">
      <div class="changWeight-con">
        <p>修改包装重量</p>
        <p class="cwtip-p">
          商品重量不能大于或则等于包装重量,现在的包装重量是 {{tipWeight}},你可以修改包装重量
        </p>
        <div class="cWcon-group">
          <label>包装重量:</label>
          <input type="number" ng-model="bzWeight"></input>
        </div>
        <div class="rk-btns">
          <button type="button" ng-click="closeCWFun()" class="btn btn-default">关闭</button>
          <button type="button" ng-click="sureCWFun()" class="btn btn-primary">确定</button>
        </div>
      </div>
    </div>
    <!-- 运单号修改包装重量 -->
    <div class="changebz-wrap index-wrap ng-hide stop-pro" ng-show="ydhchangeWFlag">
      <div class="changWeight-con">
        <p>修改包装重量</p>
        <p class="cwtip-p">
          商品重量不能大于或则等于包装重量,现在的包装重量是 {{ydhtipWeight}},你可以修改包装重量
        </p>
        <div class="cWcon-group">
          <label>包装重量:</label>
          <input type="number" ng-model="ydhbzWeight"></input>
        </div>
        <div class="rk-btns">
          <button type="button" ng-click="ydhcloseCWFun()" class="btn btn-default">关闭</button>
          <button type="button" ng-click="ydhsureCWFun()" class="btn btn-primary">确定</button>
        </div>
      </div>
    </div>
    <!-- 已经修改过包装重量 -->
    <div class="chage-wrap ng-hide stop-pro" ng-show="isNextChangeFlag">
      <div class="changWeight-con next-change">
        <p>该商品已经被称过重量,确定要再次修改吗?</p>
        <div class="rk-btns">
          <button type="button" ng-click="nextQxFun()" class="btn btn-default">关闭</button>
          <button type="button" ng-click="nextSureFun()" class="btn btn-primary">确定</button>
        </div>
      </div>
    </div>
    <!-- 已经修改过包装重量 -->
    <div class="chage-wrap ng-hide" ng-show="ydhisNextChangeFlag">
      <div class="changWeight-con next-change">
        <p>该商品已经被称过重量,确定要再次修改吗?</p>
        <div class="rk-btns">
          <button type="button" ng-click="ydhnextQxFun()" class="btn btn-default">关闭</button>
          <button type="button" ng-click="ydhnextSureFun()" class="btn btn-primary">确定</button>
        </div>
      </div>
    </div>
    <!-- 是否签收 -->
    <div class="chage-wrap ng-hide" ng-show="isqianshouFlag">
      <div class="changWeight-con next-change">
        <p>确定签收吗?</p>
        <div class="rk-btns">
          <button type="button" ng-click="ydhNoQs()" class="btn btn-default">关闭</button>
          <button type="button" ng-click="ycqsFun()" class="btn btn-warning qs-btn">异常签收</button>
          <button type="button" ng-click="ydhSureQs()" class="btn btn-primary qs-btn">确定</button>
        </div>
      </div>
    </div>
    <!-- 批量打印条形码 -->
    <div class="chage-wrap ng-hide" ng-show="txmTkFlag">
      <div class="changWeight-con next-change">
        <a target="_blank" ng-href="{{'https://'+txmHref}}">{{'https://'+txmHref}}</a>
        <div class="rk-btns">
          <button type="button" ng-click="txmTkFlag=false" class="btn btn-default">关闭</button>
        </div>
      </div>
    </div>
    <!-- 异常签收 -->
    <div class="chage-wrap" ng-show="qsycResonFlag" ng-cloak>
      <div class="changWeight-con qs-con">
        <div class="qs-res-con">
          <textarea ng-model="qsycReson"></textarea>
        </div>
        <div class="rk-btns">
          <button type="button" ng-click="qsycResonFlag=false" class="btn btn-default">关闭</button>
          <button type="button" ng-click="qsycSureFun()" class="btn btn-primary qs-btn">确定</button>
        </div>
      </div>
    </div>
    <!-- 异常的原因 -->
    <div class="chage-wrap" ng-show="ycYyFlag" ng-cloak>
      <div class="changWeight-con qs-con" style="height: 300px;">
        <div class="qs-res-con" style="margin-bottom: 20px;">
          <span style="width: 90px;text-align: left;display: inline-block;">数量:</span>
          <input type="number" ng-model="ycCount" style="width: 200px;height: 30px;"></input>
        </div>
        <div class="qs-res-con" style="margin-bottom: 20px;">
          <span style="width: 90px;text-align: left;display: inline-block;">异常原因:</span>
          <select ng-model="ycYyVal" style="width: 200px;height: 30px;">
            <option value="2">质量问题</option>
            <option value="4">其它</option>
          </select>
        </div>
        <div class="qs-res-con">
          <textarea ng-model="newQsYcReson"></textarea>
        </div>
        <div class="rk-btns">
          <button type="button" ng-click="ycYyFlag=false" class="btn btn-default">关闭</button>
          <button type="button" ng-click="sureYcFun()" class="btn btn-primary qs-btn">确定</button>
        </div>
      </div>
    </div>
    <!-- 修改商品重量确认 -->
    <div class="chage-wrap ng-hide" ng-show="updateWeightConfirmBox">
      <div class="changWeight-con next-change">
        <p>该商品已经被称过重量,确定要再次修改吗?</p>
        <div class="rk-btns">
          <button type="button" ng-click="updateWeightConfirmBox=false" class="btn btn-default">关闭</button>
          <button type="button" ng-click="handleChangeWeightConfirm()" class="btn btn-primary">确定</button>
        </div>
      </div>
    </div>
    <!-- 修改邮寄重量 -->
    <div class="changebz-wrap index-wrap ng-hide stop-pro" ng-show="updateMailWeightBox">
      <div class="changWeight-con">
        <p>修改包装重量</p>
        <p class="cwtip-p">
          商品重量不能大于或则等于包装重量,现在的包装重量是 {{updateWeightParams.actualMailWeight}},商品重量是{{updateWeightParams.productActualWeight}}，你可以修改包装重量
        </p>
        <div class="cWcon-group">
          <label>包装重量:</label>
          <input type="number" ng-model="mailweight"></input>
        </div>
        <div class="rk-btns">
          <button type="button" ng-click="updateMailWeightBox=false" class="btn btn-default">关闭</button>
          <button type="button" ng-click="handleChangeMailWeightConfirm()" class="btn btn-primary">确定</button>
        </div>
      </div>
    </div>
    <!-- 异常的原因 -->
    <div class="chage-wrap" ng-show="errorbox" ng-cloak>
      <div class="changWeight-con qs-con" style="height: 300px;">
          <div class="qs-res-con" style="margin-bottom: 20px;">
              <span style="width: 90px;text-align: left;display: inline-block;">数量:</span>
              <input type="number" ng-model="params.badNum" style="width: 200px;height: 30px;" ng-keyup="handleNumberLimit()" maxlength="5"></input>
          </div>
          <div class="qs-res-con" style="margin-bottom: 20px;">
              <span style="width: 90px;text-align: left;display: inline-block;">异常原因:</span>
              <select ng-model="params.badType" style="width: 200px;height: 30px;">
                  <option value="1">损坏</option>
                  <option value="2">缺货</option>
                  <option value="3">其它</option>
              </select>
          </div>
          <div class="qs-res-con">
              <textarea ng-model="params.badRemark"></textarea>
          </div>
          <div class="rk-btns">
              <button type="button" ng-click="hideErrBox()" class="btn btn-default">关闭</button>
              <button type="button" ng-click="submitError()" class="btn btn-primary qs-btn">确定</button>
          </div>
      </div>
  </div>
</body>
<script src="./static/js/public/base64.min.js"></script>
<script src="./static/js/public/common.js"></script>
<script src='./static/layer/layer.js'></script>
<script type="text/javascript">
(function (angular) {
    var app = angular.module('barcodeApp',['service']);
    app.controller('barcodeAppCtrl',['$scope',"erp",function ($scope,erp) {
      $("#tx").focus();
      // $(document).click(function () {
      //   $("#tx").focus();
      // })

      $scope.condition = 'latestVersion';//  新增泰国仓查询 接口不一致  显示不一样 (oldVersion 3种情况  latestVersion 泰国地区 操作)
      $scope.list = [];//新增需求 产品列表
      $scope.errorbox = false;//显示隐藏 异常操作窗口
      $scope.params = {//异常提交所需参数
        id: '',
        badNum: 0,//异常数量ba
        productNum: 0,
        badType: '',//异常类型
        badRemark: '' //描述
      };
      $scope.updateWeightParams = {//更新包裹重量 所需参数
        actualMailWeight: 0,
        packageProductId: '',
        productActualWeight: 0
      }
      $scope.mailweight = 0;
      $scope.updateWeightConfirmBox = false;// 修改商品重量后  if < 邮寄重量 显示 
      $scope.updateMailWeightBox = false;   // 修改商品重量后  if >= 邮寄重量 显示 修改邮寄重量 
      $scope.showErrBox = function ({id}) {
        layer.load(2);
        erp.postFun('supplier/supplierPackageProduct/number/exception/detail', {id}, function({data}) {
          layer.closeAll('loading');
          const { data: res, code, error } = data;
          if (code !== 200) return layer.msg(error || '系统错误 请联系管理员');
          console.log('getErrBoxInfoHttp', res)
          const { badRemark, badType, badNum, productNum } = res;
          $scope.errorbox = true;
          $scope.params = {//异常提交所需参数
            id,
            badNum: +badNum || 0,//异常数量ba
            productNum: +productNum || 0, //商品数量 异常数量不能大于 商品数量
            badType: badType ? badType + '' : '',//异常类型
            badRemark: badRemark || '' //描述
          };
          console.log('get errboxinfo', $scope.params)
        }, function(err) {
          console.log('err', err);
          layer.msg('系统错误 请联系管理员');
        })
      }
      // function(goods) {//显示操作窗口
      //   $scope.errorbox = true;
      //   $scope.params.id = goods.id;
      //   $scope.params.badNum = +goods.productNum;
      //   console.log(goods, 'goods')
      // }
      $scope.hideErrBox = function() {//隐藏操作窗口
        $scope.params = { id: '',  badNum: 0, badType: '', badRemark: '' };
        $scope.errorbox = false;
      }
      $scope.handleNumberLimit = function() {// 异常数量不能大于 商品数量
        let { badNum, productNum } = $scope.params;
        if (+badNum > +productNum) {
            $scope.params.badNum = +productNum;
        }
      }
      const submitErrorThottle = throttle(submitErrorHttp)
      $scope.submitError = function() {//提交异常
        console.log('submitError params', $scope.params)
        let { id, badType, badRemark, badNum, productNum } = $scope.params;
        if (!id) return layer.msg('未定位到异常 请重新操作');
        if (!badType) return layer.msg('请选择异常原因');
        if (!badRemark) return layer.msg('请填写异常描述');
        if (badNum == 0) return layer.msg('提交异常数量须大于0');
        if (badNum > productNum) return layer.msg('异常数量不能大于商品数量');
        $scope.params.badType = badType + '';
        submitErrorThottle()
      }
      
      function submitErrorHttp() {//提交异常 http
        // console.log($scope.params, 'params')
        layer.load(2);
        const url = 'supplier/supplierPackageProduct/number/exception/update';
        erp.postFun(url, $scope.params, function() {
          layer.closeAll('loading');
          $scope.errorbox = false;
          layer.msg('异常提交成功');
        }, function(err) {
          console.log('err', err);
          $scope.errorbox = false;
          layer.msg('异常提交失败 请重新操作');
        })
      }
      function throttle(fn, wait=1) {
        let lastTime = Date.now();
        return function() {
          let currentTime = Date.now();
          if (currentTime - lastTime > wait * 1000) {
            lastTime = currentTime;
            fn.apply(this, arguments)
          }
        }
      }
      $scope.checkWeight = function(goods, i, ev) {//修改重量后失去焦点 事件  -->> list 数据 获取 item init updateWeightParams
        $scope.updateWeightConfirmBox = true;
        const { id, weight, grams } = goods;
        const value = $(ev.target).val();
        $scope.updateWeightParams = {//更新包裹重量 所需参数
          actualMailWeight: weight,
          packageProductId: id,
          productActualWeight: +value
        }
        $scope.mailweight = weight;
        console.log('updateWeightParams --> ', $scope.updateWeightParams)
      }
      const handleUpdateWeightHttpThrottle = throttle(handleUpdateWeightHttp)
      $scope.handleChangeWeightConfirm = function() {//确认修改 商品重量 
        const { actualMailWeight, packageProductId, productActualWeight } = $scope.updateWeightParams;
        const params = { actualMailWeight, packageProductId, productActualWeight };
        if (actualMailWeight > productActualWeight ) return handleUpdateWeightHttpThrottle(params) //邮寄重量 > 商品重量 执行 http修改重量操作
        $scope.updateWeightConfirmBox = false; //邮寄重量 <= 商品重量  关闭 修改 商品重量 窗口
        $scope.updateMailWeightBox = true;//邮寄重量 <= 商品重量  开启 修改 邮寄重量 窗口
      }
      $scope.handleChangeMailWeightConfirm = function() {//确认修改 邮寄商品重量 
        const { packageProductId, productActualWeight } = $scope.updateWeightParams;
        const actualMailWeight = $scope.mailweight;
        if (+actualMailWeight <= +productActualWeight) return layer.msg('邮寄重量须大于商品重量');
        const params = {actualMailWeight, packageProductId, productActualWeight}
        handleUpdateWeightHttpThrottle(params)
      }
      
      function handleUpdateWeightHttp(params) {//修改重量的  http
        const url = `supplier/supplierPackageProduct/actual/weight/update`;
        console.log('handleUpdateWeightHttp params--> ', url, params)
        layer.load(2);
        erp.postFun(url, params, function() {
          layer.closeAll('loading');
          $scope.list = $scope.list.map(goods => {
            if (goods.id === params.packageProductId) {
              const { actualMailWeight, productActualWeight } = params;
              Object.assign(goods, {weight: actualMailWeight, grams: productActualWeight})
            } 
            return goods;
          })
          layer.msg('重量修改成功');
          $scope.updateWeightConfirmBox = false;
          $scope.updateMailWeightBox = false;
        }, function() {
          layer.msg('重量修改失败 请重新操作');
          $scope.updateWeightConfirmBox = false;
          $scope.updateMailWeightBox = false;
        })
      }
      function queryList() {//获取产品列表接口
        let code = $.trim($("#tx").val());
        layer.load(2);
        const url = 'supplier/supplierPackageProduct/getPackageProduct' + '?logisticsNumber=' + code;
        erp.getFun(url, function (data) {
          layer.closeAll('loading');
          var res = data.data && data.data.data;
          if (!res || res.length === 0) {
            $scope.condition = 'oldVersion';
            $scope.showSpFun();//新的接口没有数据 调用老的接口 
          }
          res.forEach(item => {
            let sku = item.sku;
            item.skuLeft = sku.substring(0, 14)
            item.skuRight = sku.substr(14)
          })
          $scope.list = res;
          $("#tx").val('')
        })
      }

      $("#vsku").focus(function(){
         $("#tx").focus();
      });
      var responseObj;
      var storageId;
      var menuId;
      var ydhGlobelNum;
      //扫码展示商品信息
      var code;
      $scope.showSpFun = function () {
        var b=true;
        code=$("#tx").val();
        ydhGlobelNum = $("#tx").val();
        // var code="5222875592366";
        // $("#tx").val("");
        console.log("---"+code+"---");
        if(code==null||code==""){
          layer.msg("请求失效  请刷新页面后重试");
        }else{
          //发送ajac请求 获取到当前码对应的 sku信息
          responseObj = {};
          layer.load(2);
          // caigou/procurement/chenZhong {inputStr: ''}  ---->> procurement/order/chenZhong {inputStr: ''}
          erp.postFun("procurement/order/chenZhong",{"inputStr":code},function({data: {data}}){
            layer.closeAll('loading');
            $scope.ydhList = data;
            $("#tx").focus();
            $('#YdhModal').attr("class","model show");
            $("#exampleModal").attr("class","model hide");
            return //接口迁移 新街口 只有数组 可能
             console.log(data)
             console.log(data.data.result)
             var resObj = JSON.parse(data.data.result);
             // console.log(typeof(resObj.toString()))
             if (Object.prototype.toString.call(resObj) === '[object Array]') {//sku或则条形码
                 // console.log('array')
                 resObj=resObj[0];
                 /* var da=new Date(obj.dateTime.time); */
                 console.log(resObj);
                 responseObj = resObj;
                 $("#vimg").attr("src",resObj.img)
                 $("#vdt").val(''+new Date(resObj.dateTime.time).getFullYear()+'-'+(new Date(resObj.dateTime.time).getMonth()+1)+'-'+new Date(resObj.dateTime.time).getDate());
                 $("#vco").val(resObj.count);
                 $("#vcone").val(resObj.ones);
                 $("#vcmore").val(resObj.mores);
                 $("#vsku").val(resObj.sku);
                 /* $("#bt").trigger("click"); */
                 $("#tx").focus();
                 $("#exampleModal").attr("class","model show");
                 $('#YdhModal').attr("class","model hide");
             } else {
                 console.log('Object')
                 responseObj = resObj;
                 $scope.ydhList = resObj.wayBills;
                 console.log($scope.ydhList);
                 $("#tx").focus();
                 $('#YdhModal').attr("class","model show");
                 $("#exampleModal").attr("class","model hide");
                 // 实时获取重量
                //  var clearInterval = timer()
                //  $scope.clearInterval = clearInterval
             }
          });
        }
      }
      //异常
      $scope.ycYyVal = '2';
      var itemYcId;
      $scope.yiChangFun = function (item) {
        itemYcId = '';
        $scope.ycCount = 0;
        console.log(item)
        $scope.ycYyFlag = true;
        $scope.ycCount = item.count-0;
        itemYcId = item.caiGouShangPinid;
      }
      $scope.sureYcFun = function () {
        if($scope.ycCount<=0||!$scope.ycCount){
          layer.msg('请输入数量')
          return
        }
        if ($scope.ycYyVal=='4') {
          if(!$scope.newQsYcReson){
            layer.msg('请输入异常原因')
            return
          }
        }
        erp.load()
        var ycUpJoson = {};
        ycUpJoson.id = itemYcId;
        ycUpJoson.yuanYin = $scope.newQsYcReson;
        ycUpJoson.shuLiang = $scope.ycCount;
        ycUpJoson.leiXing = $scope.ycYyVal;
        const url = 'procurement/dealWith/yiChang';//接口更改 
        erp.mypost(url, ycUpJoson).then(() => {
          $scope.ycYyFlag = false;
        })
      }
      //批量打印条形码
      $scope.bulkPrintOFun = function () {
        console.log($scope.ydhList)
        var printData = {};
        var printArr = [];
        for(var i = 0;i<$scope.ydhList.length;i++){
            // var sku = $scope.ydhList[i].shortSku;
            var sku = $scope.ydhList[i].sku;
            var count = printData[sku];
            if (count==undefined) {
              count = $scope.ydhList[i].count;
            }else{
              count = $scope.ydhList[i].count + count;
            }
            printData[sku] = count;
        }
        console.log(printData)
        // return;
        layer.load(2)
        var pUpdata = {};
        pUpdata.skuMap = printData;
        console.log(JSON.stringify(pUpdata))
        erp.postFun('app/pdfOpt/getBarcode128Batch',JSON.stringify(pUpdata),function (data) {
          console.log(data)
          layer.closeAll('loading');
          if(data.data.code=='200'){
            $scope.txmTkFlag = true;
            $scope.txmHref = data.data.pdfFillUrl;
            console.log($scope.txmHref)
          }else{
            layer.msg('打印错误')
          }
          
        },function (data) {
          console.log(data)
          layer.closeAll('loading');
        })
      }
      $('#YdhModal').click(function (e) {
        e.stopPropagation();
      })
      $('.ydh-rk-wrap').click(function (e) {
        e.stopPropagation();
      })
      $('.stop-pro').click(function (e) {
        e.stopPropagation();
      })
      $('.chage-wrap').click(function (e) {
        e.stopPropagation();
      })
      // 清除实时获取重量
      $scope.isVaildFocus = function() {
        // clearTimeout($scope.clearInterval)
      }
      // // 重新实时获取重量
      // $scope.setWeight = function() {
      //   $scope.weightShow = false
      //   var clearInterval = timer()
      //   $scope.clearInterval = clearInterval
      // }
      //运单号入库 修改重量的函数
      var targetVal;
      $scope.thisList;
      $scope.thisIndex;
      $scope.isValidWFun = function (item,index,ev) {
        targetVal = $(ev.target).val();
        console.log(targetVal)
        console.log(item)
        $scope.thisIndex = index;
        $scope.itemOldWei = item.oldWeight;
        $scope.thisList = $scope.ydhList[index];
        if (item.isChangeWeight!='1') {//如果没有修改过 提示修改
            if (targetVal>item.packWeight) {
              $scope.ydhchangeWFlag = true;
              $scope.tipWeight = item.packWeight;
              $scope.ydhbzWeight = item.packWeight;
            } else if(targetVal==item.oldWeight){
              return;
            } else {
              if (targetVal<=0) {
                layer.msg('请输入重量')
                return;
              }
              erp.postFun('pojo/procurement/changeWeight',{
                productId:item.productId,
                variantId:item.variantId,
                oldWeight:item.oldWeight,
                newWeight:targetVal
              },function (data) {
                console.log(data)
                if (data.data.statusCode==200) {
                  // layer.msg('修改成功')
                  $scope.ydhList[index].isChangeWeight = '1';
                  $scope.ydhList[index].oldWeight = targetVal;
                  $scope.ydhisNextChangeFlag = false;
                } else {
                  layer.msg(item.sku + ' 修改失败')
                }
              },function (data) {
                console.log(data)
              })
            }
        } else {//如果修改过
          if(targetVal==item.oldWeight){
            return;
          }
          $scope.ydhisNextChangeFlag = true;
          // $scope.ydhList[$scope.thisIndex].oldWeight = targetVal-0;
          // console.log(item)
          // console.log($scope.ydhList)
        }
        
      }
      //运单号入库 再次修改商品重量
      $scope.ydhnextQxFun = function () {
        $scope.ydhisNextChangeFlag = false;
        $('.ydh-weightInp').eq($scope.thisIndex).val($scope.itemOldWei);
        // console.log($scope.itemOldWei)
        // $scope.ydhList[$scope.thisIndex].oldWeight = $scope.itemOldWei;
        // console.log($scope.ydhList[$scope.thisIndex])
        // console.log($scope.ydhList)
      }
      //确定再次修改重量
      $scope.ydhnextSureFun = function () {
        console.log($scope.thisList)
        if (targetVal<=0) {
          layer.msg('请输入重量')
          return;
        } else if(targetVal>=$scope.thisList.packWeight){//净重量大于包装重量
          $scope.ydhchangeWFlag = true;
          $scope.ydhtipWeight = $scope.thisList.packWeight;
          return;
        }
        $scope.isNextChangeFlag = false;
        layer.load(2);
        erp.postFun('pojo/procurement/changeWeight',{
          productId:$scope.thisList.productId,
          variantId:$scope.thisList.variantId,
          oldWeight:$scope.thisList.oldWeight,
          newWeight:targetVal
        },function (data) {
          layer.closeAll('loading');
          console.log(data)
          if (data.data.statusCode==200) {
            $scope.ydhisNextChangeFlag = false;
            layer.msg('修改成功')
            $scope.ydhList[$scope.thisIndex].isChangeWeight = '1';
            $scope.ydhList[$scope.thisIndex].oldWeight = targetVal;
          } else {
            layer.msg('修改失败')
            isChangeWeight = false;
            $('.rk-weight').addClass('inp-erractive')
          }
        },function (data) {
          console.log(data)
        })
      }
      //运单号入库按钮
      $scope.ydhRkFun = function () {
        // console.log('00098978')
        console.log($scope.ydhList)
        console.log(responseObj)
        $scope.bulkRkTime = timestampToTime(new Date())
        console.log(timestampToTime(new Date()))
        // layer.msg('开发中')
        $scope.ydhrkFlag = true;
      }
      // $scope.ydhRkFun()
      //运单号入库的取消 确定
      $scope.ydhRkSureFun = function () {
        console.log($scope.ydhList)
        //{"list":[{variantId,productId,waybillId,count},....], storageId}
        var upObj = {};//存储上传的参数
        var upListArr = [];//存储list数组
        var arrOneObj = {};//存储数组中的一条
        var itemStoreId;
        for(var i = 0;i<$scope.ydhList.length;i++){
          if ($scope.ydhList[i].isChangeWeight != '1') {
            layer.msg('请修改商品的重量')
            return;
          }else{
            arrOneObj.variantId = $scope.ydhList[i].variantId;
            arrOneObj.productId = $scope.ydhList[i].productId;
            arrOneObj.wayBillId = $scope.ydhList[i].id;
            arrOneObj.count = $scope.ydhList[i].count;
            itemStoreId = $scope.ydhList[i].storageId;
          }
          upListArr.push(arrOneObj);
        }
        // upObj.list = JSON.stringify($scope.ydhList)
        layer.load(2)
        upObj.list = upListArr;
        upObj.storageId = itemStoreId;
        upObj.trackingNumber = code;
        console.log(upObj)
        console.log(JSON.stringify(upObj))
        // return;
        erp.postFun('pojo/procurement/inStorages',JSON.stringify(upObj),function (data) {
          console.log(data)
          layer.closeAll('loading')
          if (data.data.statusCode == '200') {
            layer.msg('批量入库成功')
            // $scope.ydhrkFlag = false;
            $scope.ydhList = [];
            $("#tx").val("");
            setTimeout(function (){
              $("#tx").blur().focus();
            },100);
          } else {
            layer.msg('批量入库失败')
          }
        },function (data) {
          console.log(data)
          layer.closeAll('loading')
        })
      }
      $scope.ydhCloseRk = function () {
        $scope.ydhrkFlag = false;
      }
      $scope.ydhRkQsFun = function () {
        $scope.isqianshouFlag = true;
      }
      //询问是否签收
      $scope.ydhNoQs = function () {
        $scope.isqianshouFlag = false;
      }
      //签收
      $scope.ydhSureQs = function () {
        erp.getFun('pojo/procurement/sign?wayBill='+ydhGlobelNum,function (data) {
          if (data.data.statusCode=='200') {
            $scope.isqianshouFlag = false;
            layer.msg('签收成功')
          } else {
            layer.msg('签收失败')
          }
        },function (data) {
          console.log(data)
        })
      }
      //异常签收
      $scope.ycqsFun = function () {
        $scope.qsycResonFlag = true;
      }
      $scope.qsycSureFun = function () {
        if (!$scope.qsycReson) {
          layer.msg('请输入异常原因')
          return;
        }
        var ycqsData = {};
        ycqsData.wayBillId = code;
        ycqsData.exceptionResone = $scope.qsycReson;
        erp.postFun('pojo/procurement/daoHuoYiChang',JSON.stringify(ycqsData),function (data) {
          console.log(data)
          if (data.data.statusCode==200) {
            $scope.qsycResonFlag = false;
            $scope.isqianshouFlag = false;
            layer.msg('异常签收成功')
          } else {
            layer.msg('异常签收失败')
          }
        },function (data) {
          console.log(data)
        })
      }
      //运单号的修改包装重量
      $scope.ydhcloseCWFun = function () {
        $scope.ydhchangeWFlag = false;
      }
      $scope.ydhsureCWFun = function function_name() {
        if ($scope.ydhbzWeight<=0) {
          layer.msg('请输入重量')
          return;
        }
        layer.load(2);
        erp.postFun('pojo/procurement/changePackWeight',{
          productId:$scope.thisList.productId,
          variantId:$scope.thisList.variantId,
          oldWeight:$scope.thisList.oldWeight,
          newWeight:$scope.ydhbzWeight
        },function (data) {
          layer.closeAll('loading');
          console.log(data)
          if (data.data.statusCode==200) {
            layer.msg('修改成功')
            $scope.ydhList[$scope.thisIndex].packWeight = $scope.ydhbzWeight;
            $scope.ydhchangeWFlag = false;
          } else {
            layer.msg('修改失败')
          }
        },function (data) {
          console.log(data)
        })
      }

      $('#tx').keypress(function(e) { 
        if(e.which == 13) {  
          $scope.condition = 'latestVersion';
          queryList()
        } 
       }); 
        $('.rk-wrap').click(function (e) {
          e.stopPropagation();
        })
        $('#weight-con').click(function (e) {
          e.stopPropagation();
        })
        var isChangeWeight = false;
        //点击入库按钮
        $scope.rkBtnFun = function (ev) {
          // $(ev.target).stopPropagation();
          console.log(responseObj)
          $scope.skuorTxmFlag = true;
          if (responseObj.storageId01) {//如果是sku需要选择仓库
              $scope.moreFlag = true;//显示入库的单选按钮
              $("#tx").blur();
              $(".rk-sp-img").attr("src",responseObj.img)
              $('.rk-num').val(responseObj.mores);//填入获取到的多品数量
              $('.rk-weight').val(responseObj.oldWeight);//填入商品重量
              $('.sku-text').text(responseObj.sku);//填入sku
              $('.rk-wrap').show();
              if (responseObj.isChangeWeight==0) {//没有修改过重量
                isChangeWeight = false;
                $('.rk-weight').removeClass('inp-sucactive')
                $('.rk-weight').addClass('inp-erractive')
              } else {
                isChangeWeight = true;
                $('.rk-weight').removeClass('inp-sucactive')
                $('.rk-weight').addClass('inp-sucactive')
              }
              storageId = responseObj.storageId;
              menuId = responseObj.firstCategoryId;
              //默认展示义乌仓
              renderBrunch();
          } else {
              $scope.moreFlag = false;
              $("#tx").blur();
              $(".rk-sp-img").attr("src",responseObj.img)
              $('.rk-num').val(responseObj.mores);//填入获取到的多品数量
              $('.rk-weight').val(responseObj.oldWeight);//填入商品重量
              $('.sku-text').text(responseObj.sku);//填入sku
              $('.rk-wrap').show();
              if (responseObj.isChangeWeight==0) {
                isChangeWeight = false;
                $('.rk-weight').removeClass('inp-sucactive')
                $('.rk-weight').addClass('inp-erractive')
                // alert('false')
              } else {
                isChangeWeight = true;
                $('.rk-weight').removeClass('inp-sucactive')
                $('.rk-weight').addClass('inp-sucactive')
                // alert('true')
              }
              storageId = responseObj.storageId;
              menuId = responseObj.firstCategoryId;
              console.log(responseObj)
              console.log(storageId)
              console.log(menuId)
              renderBrunch();
          }
        }
        //如果是sku入库 需要选择仓库
        $scope.selCkFun = function (ev) {
          console.log($(ev.target).val())
          var selRadioVal = $(ev.target).val();
          switch (selRadioVal) {
            case '1':
              storageId = responseObj.storageId;
              erp.postFun('app/storagedo/selectByCatIdNodeList', JSON.stringify({
                  storageId:storageId,
                  idList: menuId
              }), function (data) {
                  console.log(data);
                  // var resArr = data.data.list;
                  $scope.folderData = data.data.root;
                  $scope.folderData.open = true;
                  $scope.folderData.active = true;
                  $scope.folderData.codeType = '仓';
                  $scope.folder = $scope.folderData
                  $scope.brunchItem = $scope.folderData;
                  console.log($scope.brunchItem)
              },err);
              break;
            case '2':
              storageId = responseObj.storageId01;
              erp.postFun('app/storagedo/selectByCatIdNodeList', JSON.stringify({
                  storageId:storageId,
                  idList: menuId
              }), function (data) {
                  console.log(data);
                  // var resArr = data.data.list;
                  $scope.folderData = data.data.root;
                  $scope.folderData.open = true;
                  $scope.folderData.active = true;
                  $scope.folderData.codeType = '仓';
                  $scope.folder = $scope.folderData
                  $scope.brunchItem = $scope.folderData;
                  console.log($scope.brunchItem)
              },err);
              break;
            case '3':
              storageId = responseObj.storageId02;
              erp.postFun('app/storagedo/selectByCatIdNodeList', JSON.stringify({
                  storageId:storageId,
                  idList: menuId
              }), function (data) {
                  console.log(data);
                  // var resArr = data.data.list;
                  $scope.folderData = data.data.root;
                  $scope.folderData.open = true;
                  $scope.folderData.active = true;
                  $scope.folderData.codeType = '仓';
                  $scope.folder = $scope.folderData
                  $scope.brunchItem = $scope.folderData;
                  console.log($scope.brunchItem)
              },err);
              break;
          }

        }
        //修改重量
        $scope.editWeiFun = function () {
          console.log(responseObj)
          var newWeightVal = $('.rk-weight').val();
          if (responseObj.isChangeWeight==0) {
            if (newWeightVal<=0) {
              layer.msg('请输入重量')
              return;
            } else if(newWeightVal>=responseObj.packWeight){//净重量大于包装重量
              $scope.changeWFlag = true;
              $scope.bzWeight = responseObj.packWeight;
              $scope.tipWeight = responseObj.packWeight;
              return;
            }
            erp.postFun('pojo/procurement/changeWeight',{
              productId:responseObj.productId,
              variantId:responseObj.variantId,
              oldWeight:responseObj.oldWeight,
              newWeight:newWeightVal
            },function (data) {
              console.log(data)
              if (data.data.statusCode==200) {
                // layer.msg('修改成功')
                isChangeWeight = true;
                $('.rk-weight').addClass('inp-sucactive')
              } else {
                layer.msg(responseObj.sku +' 修改失败')
                isChangeWeight = false;
                $('.rk-weight').addClass('inp-erractive')
              }
            },function (data) {
              console.log(data)
            })
          } else {
            $scope.isNextChangeFlag = true;
          }
          //取消再次修改
          $scope.nextQxFun = function () {
            $scope.isNextChangeFlag = false;
          }
          //确定再次修改
          $scope.nextSureFun = function () {
            var newWeightVal = $('.rk-weight').val();
            if (newWeightVal<=0) {
              layer.msg('请输入重量')
              return;
            } else if(newWeightVal>=responseObj.packWeight){//净重量大于包装重量
              $scope.changeWFlag = true;
              $scope.bzWeight = responseObj.packWeight;
              $scope.tipWeight = responseObj.packWeight;
              return;
            }
            $scope.isNextChangeFlag = false;
            layer.load(2);
            erp.postFun('pojo/procurement/changeWeight',{
              productId:responseObj.productId,
              variantId:responseObj.variantId,
              oldWeight:responseObj.oldWeight,
              newWeight:newWeightVal
            },function (data) {
              layer.closeAll('loading');
              console.log(data)
              if (data.data.statusCode==200) {
                layer.msg('修改成功')
                isChangeWeight = true;
                $('.rk-weight').addClass('inp-sucactive')
              } else {
                layer.msg('修改失败')
                isChangeWeight = false;
                $('.rk-weight').addClass('inp-erractive')
              }
            },function (data) {
              console.log(data)
            })
          }
        }
        //关闭sku/条形码入库弹框
        $scope.skuOrTxmCloseFun = function () {
          $scope.skuorTxmFlag = false;
        }
        
        $scope.sureRkFun = function () {
          // responseObj = JSON.parse(arr)
          console.log(responseObj)
          var dpCount = responseObj.count;//多品的总数量
          var spId = responseObj.productId;//商品id
          var btId = responseObj.variantId;//变体id
          var ydId = responseObj.wayBillId;//运单id
          // var storageId = responseObj.storageId;//仓库id
          var rkCount = $('.rk-num').val();//获取入库数量
          var upckId = $scope.brunchItem.id;//该层级的id
          var rkData = {};
          if (!isChangeWeight) {
            layer.msg('请修改商品的重量')
            return;
          } else {
            rkData.waybillId = ydId;
            rkData.storageId = storageId;
            rkData.areaId = upckId;
            rkData.count = rkCount;
            rkData.variantId = btId;
            rkData.productId = spId;
            console.log(rkCount) 
            if (!$scope.moreFlag) {
                if (rkCount<0) {
                   layer.msg('输入的数量不能小于零')
                   return;
                }else{
                  if (rkCount*1>dpCount*1) {
                    layer.msg('输入的数量不能大于总数量')
                    return;
                  }
                }
            } else {
                if (rkCount<0) {
                   layer.msg('输入的数量不能小于零')
                   return;
                }
            }   
            erp.load();
            // storageId = responseObj.storageId;//仓库id
            
            console.log(dpCount,spId,btId,ydId,rkCount,upckId)
            console.log(JSON.stringify(rkData))
            erp.postFun('pojo/procurement/inStorage',JSON.stringify(rkData),function (data) {
              console.log(data)
              $('.rk-wrap').hide();
              erp.closeLoad()
              if (data.data.statusCode==200) {
                $scope.skuorTxmFlag = false;
                layer.msg('入库成功')
              } else {
                layer.msg('入库失败')
              }
            },err)
          }
        }
        $scope.closeRkFun = function () {
          $('.rk-wrap').hide();
        }
        //修改包装重量
        $scope.closeCWFun = function () {
          $scope.changeWFlag = false;
        }
        $scope.sureCWFun = function function_name() {
          console.log($scope.bzWeight)
          console.log(responseObj)
          if ($scope.bzWeight<=0) {
            layer.msg('请输入重量')
            return;
          }
          layer.load(2);
          // 数千
          erp.postFun('pojo/procurement/changePackWeight',{
            productId:responseObj.productId,
            variantId:responseObj.variantId,
            oldWeight:responseObj.packWeight,
            newWeight:$scope.bzWeight
          },function (data) {
            layer.closeAll('loading');
            console.log(data)
            if (data.data.statusCode==200) {
              layer.msg('修改成功')
              responseObj.packWeight = $scope.bzWeight;
              $scope.changeWFlag = false;
            } else {
              layer.msg('修改失败')
            }
          },function (data) {
            console.log(data)
          })
        }
        
        $scope.index1 = '00';
        //点击某个仓库
        $scope.pointOne = function (item,e,posi) {
            $scope.folder.active = false;
            // console.log($scope.folder)
            setAllChiToUnactive($scope.folder.childrens,'childrens');//把节点置为非选中
            $scope.pointArr = getTheArr(posi,e,$scope);
            // console.log($scope.pointArr)
            // $scope.pointArr.active = true;
            $scope.pointArr.active = true;
            // console.log($scope.folder)
            $scope.brunchItem = item;
            // 选中的仓库分支
            console.log('选中的仓库分支',$scope.brunchItem);
        }
        $scope.switchList = function (posi,e,flag) {
            $scope.temArr = getTheArr(posi,e,$scope);
            $scope.temArr.open = flag;
        }
        // 获取当前节点的信息
        function renderBrunch () {
          console.log(menuId)
            erp.postFun('app/storagedo/selectByCatIdNodeList', JSON.stringify({
                storageId:storageId,
                idList: menuId
            }), function (data) {
                console.log(data);
                // var resArr = data.data.list;
                $scope.folderData = data.data.root;
                $scope.folderData.open = true;
                $scope.folderData.active = true;
                $scope.folderData.codeType = '仓';
                $scope.folder = $scope.folderData
                $scope.brunchItem = $scope.folderData;
                console.log($scope.brunchItem)
            },err);
        }
        // renderBrunch();

    }]);
    
    app.directive("folderTree", function() {  
        return {  
            restrict: "E",  
            scope: {  
              //传入当前项的值
                currentFolder: '=',
                //循环索引的值
                myIndex: '=',
                // folderList: '=',
                //点击某个的方法
                pointOne:'&',
                // openupList: '&',
                // packupList: '&'
                //展开伸缩的方法
                switchList: '&'
            }, 
            // scope: true,
            templateUrl: 'static/template/tree.html',
        };  
    });
    function err (error) {
      erp.closeLoad();
        console.log(error);
        // layer.closeAll('loading');
    }
    //获取当前节点
    function getTheArr (posi,e,$scope,cateflag) {
        var rootArr, resArr, childFlag;
        if (cateflag) {
            rootArr = $scope.cateList; 
            childFlag = 'children';
        } else {
            rootArr = $scope.folder; 
            childFlag = 'childrens';
        }
        var temDom = e.target.parentElement;
        var firIndex = angular.element(temDom).find('.index-span').html();
        if (firIndex == '00') {
            // $scope.folder.active = true;
            console.log(firIndex);
            console.log(rootArr)
            return rootArr;
        }else {
          console.log(firIndex,6666)
        }
        var posiArr = [angular.element(temDom).find('.index-span').html() * 1];
        for (var i = 0; i < (posi); i++) {
            temDom = turnToParentIndex(temDom);
            posiArr.unshift(temDom.find('.index-span').html() * 1);
        }
        // console.log(posiArr);
        var temArr = rootArr;
        for (var i = 0; i < posiArr.length; i++) {
            temArr = turnToChildren(temArr,posiArr[i],childFlag)
        }
        return temArr;
        // console.log(temArr);
        // temArr.active = true;
    }
    function turnToChildren(arr,index,tag) {
        return arr[tag][index];
    }
    function turnToParentIndex(dom) {
        return angular.element(dom).parent().parent().parent().siblings('.top-info');
    }
    //把所有节点置为非选中
    function setAllChiToUnactive (arr,tag) {
        for (var i = 0; i < arr.length; i++) {
            arr[i].active = false;
            if (arr[i][tag] && arr[i][tag].length > 0) {
                setAllChiToUnactive(arr[i][tag],tag);
            }
        }
    }
    function sequencePlusOne (arr) {
        for (var i = 0; i < arr.length; i++) {
            arr[i].sequence = arr[i].sequence * 1 + 1;
            if (arr[i].childrens && arr[i].childrens.length > 0) {
                sequencePlusOne(arr[i].childrens);
            }
        }
    }
    //格式化时间
    function timestampToTime(date) {
        var Y,M,D,h,m,s
        Y = date.getFullYear() + '-';
        M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
        D = date.getDate() + ' ';
        h = date.getHours() + ':';
        m = date.getMinutes() + ':';
        s = date.getSeconds();
        return Y+M+D+h+m+s;
    }
    // 实时获取重量
    function timer() {
      return setInterval(function() {
        $.get('http://localhost:3000/').then(res => {
          var data = JSON.parse(res)
          // 重量--克
          var g = parseInt(data[1].g)
          $('.ydh-weightInp').val(g)
        })
      }, 333) 
    }
})(angular)   

</script>
</html>